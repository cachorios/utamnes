<?php

namespace AppBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * PeriodoRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class PeriodoRepository extends EntityRepository
{
    /**
     * getMaxNumeroLiq
     * Obtiene la liquidacion maxima para un periodo determinado
     * @param Empleador $emp
     * @param $periodo
     * @return int/mixed
     */
    public function getLiquidaciones(Empleador $emp, $periodo)
    {
//        $liqarray = array();
        $q = $this->_em->createQuery(
            "
            Select p.liquidacion, max(p.tipo) as tipo
            From AppBundle:Periodo p
            where p.empleador = :empleador AND p.vencimiento = :periodo
            GROUP BY p.liquidacion
            order BY p.liquidacion DESC, p.tipo DESC
             "
        )
            ->setParameter("empleador", $emp->getId())
            ->setParameter("periodo", $periodo);

        $liqarray = $q->getArrayResult();

        //saco un numero mas de liquidacion
        $liqmas = ($liqarray [0]['liquidacion']) + 1;


        $liqarray[] = array('liquidacion' => $liqmas, 'tipo' => 0);

//        ld($liqarray);
        uksort($liqarray, array($this, 'misort'));
//        ld('---------------',$liqarray);


//        array_multisort(
//            $liqarray[0],
//            SORT_NUMERIC,
//            SORT_DESC,
//            $liqarray[1],
//            SORT_NUMERIC,
//            SORT_DESC
//        );
//        var_dump($liqarray);

            ld($liqarray);
        return $liqarray;
    }

    public function misort($a, $b)
    {
//        ld($a['liquidacion'], $b['liquidacion']);

        return $a['liquidacion'] <= $b['liquidacion']? -1 : 1;
    }
}
